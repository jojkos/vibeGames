<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pug Banger Fiesta</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script type="module">
        // Firebase App (the core Firebase SDK) is always required and must be listed first
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Add SDKs for Firebase products that you want to use
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, Timestamp, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // --- Firebase Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pug-tagger-default-app'; 
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
             apiKey: "AIzaSyAG-fkocVppD9PUKw2Y0HU0q0mSG3B3jZo", 
             authDomain: "brainrotclickerleaderboard.firebaseapp.com", 
             projectId: "brainrotclickerleaderboard", 
             storageBucket: "brainrotclickerleaderboard.appspot.com", 
             messagingSenderId: "621809902994", 
             appId: "1:621809902994:web:4ddc238f0be3d857978d4b" 
        };

        let fbApp;
        let fbAuth;
        let db;
        let currentUserId = null; 

        try {
            fbApp = initializeApp(firebaseConfig);
            fbAuth = getAuth(fbApp);
            db = getFirestore(fbApp);
            setLogLevel('debug'); 
            console.log("Firebase initialized. App ID:", appId);

            onAuthStateChanged(fbAuth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("User signed in anonymously:", currentUserId);
                } else {
                    console.log("User is signed out. Attempting anonymous sign-in.");
                    signInAnonymously(fbAuth)
                        .then((userCredential) => {
                            currentUserId = userCredential.user.uid;
                            console.log("Signed in anonymously after initial check:", currentUserId);
                        })
                        .catch((error) => {
                            console.error("Error signing in anonymously:", error);
                            currentUserId = `fallbackUser_${Date.now()}`; 
                        });
                }
            });

        } catch (error) {
            console.error("Error initializing Firebase:", error);
            db = null; 
            fbAuth = null;
        }

        window.fbApp = fbApp;
        window.fbAuth = fbAuth;
        window.db = db;
        window.firebase = { 
            collection, addDoc, query, orderBy, limit, getDocs, Timestamp, serverTimestamp 
        };
        window.appIdGlobal = appId; 

    </script>
    <style>
        body { margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; width: 100vw; background-color: #2c2c2c; font-family: 'Press Start 2P', cursive; color: #fff; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        h1.game-title { margin: 10px 0; font-size: 1.5em; color: #ffd700; text-shadow: 2px 2px #000; text-align: center; position: relative; z-index: 10; }
        #gameContainer { width: 100%; flex-grow: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        canvas { border: 2px solid #000; background-color: #78c850; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; box-shadow: 0 0 10px rgba(0,0,0,0.5); max-width: 100%; max-height: 100%; aspect-ratio: 4 / 3; display: none; }
        
        .screen-overlay { display: none; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background-color: rgba(44, 44, 44, 0.95); z-index: 200; padding: 20px; box-sizing: border-box; }
        #menuScreen { display: flex; }
        
        #menuLogo { width: 200px; height: auto; margin-bottom: 30px; animation: pulseLogo 2s infinite ease-in-out; }
        @keyframes pulseLogo { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .menu-button, .action-button { font-family: 'Press Start 2P', cursive; font-size: 1em; color: #ffd700; background-color: rgba(80, 80, 80, 0.7); border: 2px solid #ffd700; padding: 12px 25px; margin: 8px; border-radius: 8px; cursor: pointer; text-shadow: 1px 1px #000; transition: background-color 0.2s, transform 0.1s; }
        .menu-button:hover, .action-button:hover { background-color: rgba(100, 100, 100, 0.9); transform: scale(1.05); }

        #leaderboardContent { width: 80%; max-width: 500px; max-height: 70%; overflow-y: auto; background-color: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px; border: 2px solid #ffd700; margin-bottom: 20px; }
        #leaderboardContent h2 { text-align: center; margin-top: 0; color: #ffd700; }
        #leaderboardList { list-style: none; padding: 0; margin: 0; }
        #leaderboardList li { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px dashed rgba(255,255,255,0.3); font-size: 0.9em; }
        #leaderboardList li:last-child { border-bottom: none; }
        #leaderboardList .rank { min-width: 30px; text-align: right; margin-right: 10px; }
        #leaderboardList .name { flex-grow: 1; }
        #leaderboardList .score { font-weight: bold; }
        .loading-text { text-align: center; font-size: 1em; margin: 20px; }

        #gameOverScreen h2 { font-size: 2em; color: #FF0000; margin-bottom: 20px; }
        #gameOverScreen p { font-size: 1.2em; color: #FFD700; margin-bottom: 30px; }
        #gameOverButtonsContainer { display: flex; justify-content: center; flex-wrap: wrap; }

        #controlsContainer { display: none; width: 100%; position: absolute; bottom: 0; left: 0; padding: 15px; box-sizing: border-box; justify-content: space-between; align-items: flex-end; pointer-events: none; z-index: 5; }
        .d-pad { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); width: 150px; height: 150px; gap: 5px; pointer-events: auto; }
        .control-button { background-color: rgba(80, 80, 80, 0.6); border: 2px solid rgba(255, 255, 255, 0.5); color: white; font-family: 'Press Start 2P', cursive; font-size: 1.3em; display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 10px; transition: background-color 0.1s; pointer-events: auto; }
        .control-button:active { background-color: rgba(120, 120, 120, 0.8); }
        
        #btnUpLeft { grid-area: 1 / 1 / 2 / 2; } #btnUp { grid-area: 1 / 2 / 2 / 3; } #btnUpRight { grid-area: 1 / 3 / 2 / 4; }
        #btnLeft { grid-area: 2 / 1 / 3 / 2; } #btnRight { grid-area: 2 / 3 / 3 / 4; }
        #btnDownLeft { grid-area: 3 / 1 / 4 / 2; } #btnDown { grid-area: 3 / 2 / 4 / 3; } #btnDownRight { grid-area: 3 / 3 / 4 / 4; }
        
        #actionButtons { display: flex; flex-direction: column; align-items: center; pointer-events: auto; }
        #btnDash { width: 90px; height: 90px; font-size: 0.9em; padding: 5px; text-align: center; }
        
        #buyMeACoffeeButtonContainer { position: fixed; left: 15px; bottom: 15px; z-index: 210; display: none; }
        #buyMeACoffeeButtonContainer img { width: 180px; height: auto; border-radius: 8px; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <h1 class="game-title">Pug Banger Fiesta</h1>

    <div id="menuScreen" class="screen-overlay">
        <img src="https://i.postimg.cc/TYTXPPDJ/logo-Without-Bg.png" alt="Game Logo" id="menuLogo">
        <button class="menu-button" id="btnHraj">Hraj</button>
        <button class="menu-button" id="btnZebricekMenu">Žebříček</button>
    </div>

    <div id="leaderboardScreen" class="screen-overlay">
        <div id="leaderboardContent">
            <h2>Žebříček</h2>
            <ul id="leaderboardList"></ul>
            <p id="leaderboardLoadingText" class="loading-text">Načítání...</p>
        </div>
        <button class="action-button" id="btnLeaderboardToMenu">Menu</button>
    </div>

    <div id="gameOverScreen" class="screen-overlay">
        <h2>Konec Hry!</h2>
        <p id="gameOverScore">Skóre: 0</p>
        <div id="gameOverButtonsContainer">
            <button class="action-button" id="btnSaveScoreGameOver">Uložit skóre</button> 
            <button class="action-button" id="btnZebricekGameOver">Žebříček</button> 
            <button class="action-button" id="btnGameOverToMenu">Menu</button>
        </div>
    </div>

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="controlsContainer">
        <div class="d-pad">
            <div class="control-button" id="btnUpLeft">↖</div>
            <div class="control-button" id="btnUp">▲</div>
            <div class="control-button" id="btnUpRight">↗</div>
            <div class="control-button" id="btnLeft">◀</div>
            <div></div> <div class="control-button" id="btnRight">►</div>
            <div class="control-button" id="btnDownLeft">↙</div>
            <div class="control-button" id="btnDown">▼</div>
            <div class="control-button" id="btnDownRight">↘</div>
        </div>
        <div id="actionButtons">
            <div class="control-button" id="btnDash">DASH</div>
        </div>
    </div>

    <div id="buyMeACoffeeButtonContainer">
        <a href="https://buymeacoffee.com/jojkos" target="_blank" rel="noopener noreferrer">
            <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee">
        </a>
    </div>

    <script type="module">
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menuScreen = document.getElementById('menuScreen');
        const leaderboardScreen = document.getElementById('leaderboardScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const btnHraj = document.getElementById('btnHraj');
        const btnZebricekMenu = document.getElementById('btnZebricekMenu'); 
        const btnLeaderboardToMenu = document.getElementById('btnLeaderboardToMenu');
        const btnSaveScoreGameOver = document.getElementById('btnSaveScoreGameOver'); 
        const btnZebricekGameOver = document.getElementById('btnZebricekGameOver'); 
        const btnGameOverToMenu = document.getElementById('btnGameOverToMenu');
        const buyMeACoffeeContainer = document.getElementById('buyMeACoffeeButtonContainer');
        const controlsContainer = document.getElementById('controlsContainer');
        const leaderboardListEl = document.getElementById('leaderboardList');
        const leaderboardLoadingTextEl = document.getElementById('leaderboardLoadingText');
        const gameOverScoreEl = document.getElementById('gameOverScore');

        let gameState = 'menu'; 
        let countdownValue = 3;
        let gameTimerValue = 30; 
        let gameTimerInterval;
        let countdownInterval;
        let scoreSavedThisSession = false; 

        function resizeCanvas() { 
            const gameContainer = document.getElementById('gameContainer');
            const cW = gameContainer.clientWidth, cH = gameContainer.clientHeight;
            const ratio = 4/3; let nW = cW, nH = cW/ratio;
            if (nH > cH) { nH = cH; nW = cH * ratio; }
            canvas.width = nW; canvas.height = nH; ctx.imageSmoothingEnabled = false; 
        }
        window.addEventListener('resize', resizeCanvas);
        ctx.imageSmoothingEnabled = false;

        const playerImg = new Image(); const femaleDogImg = new Image();
        let imagesToLoad = 2;

        let tagSoundSynth, failSoundSynth, backgroundMusicLoop, musicSynth; 
        const synth = window.speechSynthesis;
        let musicStarted = false; let audioInitialized = false; 

        if (typeof Tone !== 'undefined') { 
            tagSoundSynth = new Tone.Synth({oscillator:{type:"sine"},envelope:{attack:0.005,decay:0.1,sustain:0.05,release:0.1}}).toDestination();
            failSoundSynth = new Tone.Synth({oscillator:{type:"square"},envelope:{attack:0.01,decay:0.2,sustain:0,release:0.1},volume:-10}).toDestination();
            musicSynth = new Tone.Synth({oscillator:{type:"triangle8"},envelope:{attack:0.01,decay:0.2,sustain:0.1,release:0.3},volume:-12}).toDestination();
            const musicNotes = ["C4","E4","G4","C5","A4","G4","E4","C4","D4","F4","A4","D5","B4","A4","F4","D4","E4","G4","B4","E5","C5","B4","G4","E4","F4","A4","C5","F5","D5","C5","A4","F4"];
            let noteIndex = 0;
            backgroundMusicLoop = new Tone.Loop(t => {musicSynth.triggerAttackRelease(musicNotes[noteIndex++%musicNotes.length],"8n",t)},"4n");
        } else { console.warn("Tone.js not loaded."); }

        function playTagSound() { if (tagSoundSynth && Tone.context.state === 'running') tagSoundSynth.triggerAttackRelease("G5","32n",Tone.now());}
        function playFailSound() { if (failSoundSynth && Tone.context.state === 'running') failSoundSynth.triggerAttackRelease("C2","16n",Tone.now());}
        function speakText(text) { if(synth && text && audioInitialized){const u=new SpeechSynthesisUtterance(text);u.pitch=1.2;u.rate=1.1;u.lang="cs-CZ";synth.speak(u);}}
        
        function initAudioSystemOnce() { 
            if(audioInitialized)return;
            if(Tone && Tone.context.state !== 'running'){Tone.start().then(()=>{console.log("Audio started.");audioInitialized=true;}).catch(e=>console.error("Audio start err:",e));
            } else if (Tone && Tone.context.state === 'running'){audioInitialized=true;}
        }
        
        function imageLoaded() { imagesToLoad--; if(imagesToLoad===0){resizeCanvas();showMenu();}}
        playerImg.onload=imageLoaded; femaleDogImg.onload=imageLoaded;
        playerImg.src='https://i.postimg.cc/1mC0gcq3/pug.png'; femaleDogImg.src='https://i.postimg.cc/vBk60hr7/female-Pug.png';
        playerImg.onerror=()=>{console.error("Player img fail.");imageLoaded();}; 
        femaleDogImg.onerror=()=>{console.error("Female dog img fail.");imageLoaded();};

        const SPRITE_SCALE_BASE=1.5; let currentSpriteScale=SPRITE_SCALE_BASE; 
        const PLAYER_BASE_WIDTH=32, PLAYER_BASE_HEIGHT=30;
        const FEMALE_DOG_BASE_WIDTH=32, FEMALE_DOG_BASE_HEIGHT=32;
        const PLAYER_SPEED_BASE=3.5, FEMALE_DOG_SPEED_BASE=2.5;
        let playerSpeed=PLAYER_SPEED_BASE, femaleDogSpeed=FEMALE_DOG_SPEED_BASE;
        const DASH_SPEED_MULTIPLIER=2.5, DASH_DURATION=18; 
        const FLEE_RADIUS_BASE=160; let fleeRadius=FLEE_RADIUS_BASE;
        const MAX_FEMALE_DOGS=5, FEMALE_DOG_SPAWN_COOLDOWN=90; 
        const TAG_LOCK_DURATION=20, TAG_ANIMATION_TOTAL_DURATION=50; 
        const SUCCESS_TEXT_DURATION=90, PARTICLE_DURATION=30;
        const MISS_LUNGE_DURATION = 12; 
        const HEART_ANIM_DURATION = 70; 

        let player, femaleDogs=[], score=0, keys={}; 
        let femaleDogSpawnTimer=0, taggedDogInfo=null; 
        let successMessages=[]; 
        let heartAnimations = []; 
        let backgroundFlowers = []; // Array to store flower objects

        const singleTagTexts=["štěká, ale nekouše","Haf haf, a je po ptákách!","utrhnem se ze řetězu","o jé!","má naštěkáno do boudy!","psí děvka","silnější pes mrdá","beng beng beng, jak rej koranteng"];
        const multiTagTexts={2:"trojka!",3:"skuby duby du!",4:"Mega Combo!",5:"Pugtastic!"};

        function createPlayer(){const sw=PLAYER_BASE_WIDTH*currentSpriteScale,sh=PLAYER_BASE_HEIGHT*currentSpriteScale;return{x:canvas.width/2-sw/2,y:canvas.height/2-sh/2,width:sw,height:sh,speed:playerSpeed,dx:0,dy:0,isDashing:false,dashTimer:0,currentDashSpeed:0,trail:[],maxTrailLength:4,isCurrentlyTagging:false,tagLockTimer:0, isMissLungeAnimating: false, missLungeTimer: 0 };}
        function createFemaleDog(){const p=canvas.width*0.05,sw=FEMALE_DOG_BASE_WIDTH*currentSpriteScale,sh=FEMALE_DOG_BASE_HEIGHT*currentSpriteScale;return{x:Math.random()*(canvas.width-sw-2*p)+p,y:Math.random()*(canvas.height-sh-2*p)+p,width:sw,height:sh,speed:femaleDogSpeed,dx:(Math.random()-0.5)*2,dy:(Math.random()-0.5)*2,moveTimer:Math.random()*100+50};}
        function createParticle(x,y){return{x:x,y:y,size:Math.random()*5+2,speedX:(Math.random()-0.5)*4,speedY:(Math.random()-0.5)*4-2,alpha:1,duration:PARTICLE_DURATION,color:`hsl(${Math.random()*60+200},100%,70%)`};}
        
        function createFlower() {
            const petalColors = ['#FFEB3B', '#FFC107', '#FFF176', '#FF80AB', '#F8BBD0', '#E1BEE7', '#81D4FA', '#B3E5FC'];
            const x = Math.random() * canvas.width;
            const y = Math.random() * (canvas.height * 0.8) + (canvas.height * 0.2); // Avoid top 20% for stems to look better
            const stemHeight = Math.random() * 30 + 20; // 20-50px
            const centerRadius = Math.random() * 2 + 3; // 3-5px
            const petalRadius = Math.random() * 3 + 4; // 4-7px
            const numPetals = Math.floor(Math.random() * 3) + 5; // 5-7 petals
            const petalColor = petalColors[Math.floor(Math.random() * petalColors.length)];

            return { x, y, stemHeight, centerRadius, petalRadius, numPetals, petalColor, stemColor: '#4CAF50' };
        }

        document.addEventListener('keydown',(e)=>{keys[e.key.toLowerCase()]=true;initAudioSystemOnce();});
        document.addEventListener('keyup',(e)=>{keys[e.key.toLowerCase()]=false;});
        
        function handleControlPress(keyOrKeys) {
            return function(e) {
                e.preventDefault(); 
                if (Array.isArray(keyOrKeys)) {
                    keyOrKeys.forEach(k => keys[k] = true);
                } else {
                    keys[keyOrKeys] = true;
                }
                initAudioSystemOnce(); 
            }
        }
        function handleControlRelease(keyOrKeys) {
            return function(e) {
                e.preventDefault();
                if (Array.isArray(keyOrKeys)) {
                    keyOrKeys.forEach(k => keys[k] = false);
                } else {
                    keys[keyOrKeys] = false;
                }
            }
        }

        function setupButtonListeners(buttonElement, keyOrKeys) { 
            if (buttonElement) {
                buttonElement.addEventListener('touchstart', handleControlPress(keyOrKeys), { passive: false });
                buttonElement.addEventListener('touchend', handleControlRelease(keyOrKeys), { passive: false });
                buttonElement.addEventListener('mousedown', handleControlPress(keyOrKeys), { passive: false });
                buttonElement.addEventListener('mouseup', handleControlRelease(keyOrKeys), { passive: false });
                buttonElement.addEventListener('mouseleave', handleControlRelease(keyOrKeys), { passive: false });
            }
        }

        setupButtonListeners(document.getElementById('btnUp'), 'w');
        setupButtonListeners(document.getElementById('btnDown'), 's');
        setupButtonListeners(document.getElementById('btnLeft'), 'a');
        setupButtonListeners(document.getElementById('btnRight'), 'd');
        setupButtonListeners(document.getElementById('btnDash'), ' ');
        setupButtonListeners(document.getElementById('btnUpLeft'), ['w', 'a']);
        setupButtonListeners(document.getElementById('btnUpRight'), ['w', 'd']);
        setupButtonListeners(document.getElementById('btnDownLeft'), ['s', 'a']);
        setupButtonListeners(document.getElementById('btnDownRight'), ['s', 'd']);
        
        function showScreen(screenToShow){
            menuScreen.style.display='none';leaderboardScreen.style.display='none';gameOverScreen.style.display='none';
            canvas.style.display='none';controlsContainer.style.display='none';buyMeACoffeeButtonContainer.style.display='none';
            if(screenToShow==='menu')menuScreen.style.display='flex';
            else if(screenToShow==='leaderboard')leaderboardScreen.style.display='flex';
            else if(screenToShow==='gameOver')gameOverScreen.style.display='flex';
            else if(screenToShow==='game')canvas.style.display='block';
            if(screenToShow==='menu')buyMeACoffeeButtonContainer.style.display='block';
        }

        function showMenu(){
            gameState='menu';showScreen('menu');
            scoreSavedThisSession = false; 
            if(btnSaveScoreGameOver) { 
                 btnSaveScoreGameOver.disabled = false; 
                 btnSaveScoreGameOver.textContent = "Uložit skóre";
            }
            if(musicStarted&&backgroundMusicLoop){backgroundMusicLoop.stop();Tone.Transport.stop();musicStarted=false;console.log("Music stopped for menu.");}
            if(gameTimerInterval)clearInterval(gameTimerInterval);if(countdownInterval)clearInterval(countdownInterval);
        }

        btnHraj.addEventListener('click',()=>{initAudioSystemOnce();showScreen('game');startCountdown();});
        btnZebricekMenu.addEventListener('click',()=>{initAudioSystemOnce();showLeaderboard();});
        btnLeaderboardToMenu.addEventListener('click',()=>{initAudioSystemOnce();showMenu();});
        btnGameOverToMenu.addEventListener('click',()=>{initAudioSystemOnce();showMenu();});
        
        btnSaveScoreGameOver.addEventListener('click', async () => {
            initAudioSystemOnce();
            if (scoreSavedThisSession) {
                try { alert("Skóre již bylo uloženo pro tuto hru!"); } catch(e) { console.warn("Alert blocked."); }
                return;
            }
            console.log("Game Over 'Uložit skóre' button clicked. Current Score:", score);
            
            let playerName = "";
            try {
                playerName = prompt("Zadej své jméno pro žebříček (max 10 znaků):", "Hráč");
            } catch (e) {
                 console.warn("Prompt dialog for name might be blocked or unavailable:", e);
                 playerName = null; 
            }
    
            if (playerName && playerName.trim() !== "") {
                const trimmedName = playerName.trim().substring(0, 10);
                await saveScoreToLeaderboard(trimmedName, score);
                scoreSavedThisSession = true;
                btnSaveScoreGameOver.textContent = "Uloženo!";
                btnSaveScoreGameOver.disabled = true;
                try { alert("Skóre uloženo!"); } catch(e) { console.warn("Alert blocked."); }
            } else if (playerName === "") {
                console.log("Player name was empty. Score not saved.");
                try { alert("Jméno nemůže být prázdné! Skóre nebylo uloženo."); } catch(e) { console.warn("Alert blocked.");}
            } else { 
                console.log("Player cancelled name prompt or prompt failed. Score not saved.");
            }
        });

        btnZebricekGameOver.addEventListener('click', () => {
            initAudioSystemOnce();
            console.log("Game Over 'Žebříček' button clicked.");
            showLeaderboard();
        });
        
        async function saveScoreToLeaderboard(name,playerScore){
            if(!window.db){console.error("DB not init.");alert("Chyba: DB N/A.");return;}
            try{const p=`artifacts/${window.appIdGlobal}/public/data/pugTaggerScores`;
                await window.firebase.addDoc(window.firebase.collection(window.db,p),{name:name,score:playerScore,timestamp: window.firebase.serverTimestamp()});
                console.log("Score saved:",name,playerScore);
            }catch(e){console.error("Save err:",e);alert("Save err:"+e.message);}
        }

        async function showLeaderboard(){
            gameState='leaderboard';showScreen('leaderboard');
            leaderboardListEl.innerHTML='';leaderboardLoadingTextEl.textContent='Načítání...';leaderboardLoadingTextEl.style.display='block';
            if(!window.db){console.error("DB not init.");leaderboardLoadingTextEl.textContent="Chyba: DB N/A.";return;}
            try{
                const p=`artifacts/${window.appIdGlobal}/public/data/pugTaggerScores`;
                const q=window.firebase.query(window.firebase.collection(window.db,p),window.firebase.orderBy("score","desc"),window.firebase.limit(10));
                const querySnapshot=await window.firebase.getDocs(q);
                if(querySnapshot.empty){leaderboardLoadingTextEl.textContent="Žádné výsledky.";}
                else{leaderboardLoadingTextEl.style.display='none';let rank=1;
                    querySnapshot.forEach((doc)=>{const data=doc.data();const li=document.createElement('li');
                        li.innerHTML=`<span class="rank">${rank}.</span> <span class="name">${data.name}</span> <span class="score">${data.score}</span>`;
                        leaderboardListEl.appendChild(li);rank++;});
                }
            }catch(e){console.error("Leaderboard fetch err:",e);leaderboardLoadingTextEl.textContent="Chyba načítání.";}
        }

        function startCountdown(){
            gameState='countdown';
            countdownValue=3;
            if(countdownInterval) clearInterval(countdownInterval);
            countdownInterval=setInterval(()=>{
                countdownValue--;
                if(countdownValue<0){clearInterval(countdownInterval);startGame();}
            },1000);
        }
        function drawCountdown(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle="rgba(0,0,0,0.5)";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.font=`${canvas.width/8}px "Press Start 2P"`;ctx.fillStyle="#FFD700";ctx.textAlign="center";ctx.textBaseline="middle";let txt=countdownValue>0?countdownValue.toString():"START!";if(countdownValue===0)txt="START!";if(countdownValue<0)txt="";ctx.fillText(txt,canvas.width/2,canvas.height/2);}
        
        function startGame(){
            gameState='playing';
            initGameLogic();
            gameTimerValue=30;
            if(gameTimerInterval) clearInterval(gameTimerInterval);
            gameTimerInterval=setInterval(()=>{
                gameTimerValue--;
                if(gameTimerValue<0){clearInterval(gameTimerInterval);endGame();}
            },1000);
            if(audioInitialized&&backgroundMusicLoop&&!musicStarted){
                Tone.Transport.start();backgroundMusicLoop.start(0);musicStarted=true;
                console.log("Music started for game.");
            }
            controlsContainer.style.display = 'flex'; // Always show controls when game starts
        }
        function drawGameTimer(){ctx.font=`${canvas.width/30}px "Press Start 2P"`;ctx.fillStyle="#FFFFFF";ctx.textAlign="right";ctx.fillText(`Čas: ${gameTimerValue>=0?gameTimerValue:0}`,canvas.width - (canvas.width * 0.025), canvas.height * 0.06);} 
        
        let gameOverButtons=[]; 
        function endGame(){
            gameState='gameOver';
            showScreen('gameOver'); 
            gameOverScoreEl.textContent=`Skóre: ${score}`;
            scoreSavedThisSession = false; 
            if(btnSaveScoreGameOver) { 
                btnSaveScoreGameOver.disabled = false;
                btnSaveScoreGameOver.textContent = "Uložit skóre";
            }
            if(musicStarted&&backgroundMusicLoop){backgroundMusicLoop.stop();Tone.Transport.stop();musicStarted=false;console.log("Music stopped for game over.");}
        }

        function updatePlayer(){
            if(!player)return;
            if(player.isMissLungeAnimating){
                player.missLungeTimer--;
                if(player.missLungeTimer <= 0) player.isMissLungeAnimating = false;
                return; 
            }
            if(player.isCurrentlyTagging){player.tagLockTimer--;const hp=(TAG_LOCK_DURATION-player.tagLockTimer)/TAG_LOCK_DURATION;const bY=Math.sin(hp*Math.PI)*(-player.height*0.15);if(taggedDogInfo){player.x=taggedDogInfo.originalX+(taggedDogInfo.dogData.width-player.width)/2;player.y=taggedDogInfo.originalY-player.height*0.3+bY;}if(player.tagLockTimer<=0)player.isCurrentlyTagging=false;player.dx=0;player.dy=0;player.trail=[];return;}
            player.dx=0;player.dy=0;
            if(!player.isDashing){
                if(keys['w'])player.dy=-player.speed;if(keys['s'])player.dy=player.speed;
                if(keys['a'])player.dx=-player.speed;if(keys['d'])player.dx=player.speed;
                if(player.dx!==0&&player.dy!==0){const f=1/Math.sqrt(2);player.dx*=f;player.dy*=f;}
                if(keys[' ']&&!player.isDashing&&!taggedDogInfo&&!player.isCurrentlyTagging&&!player.isMissLungeAnimating){
                    player.isDashing=true;player.dashTimer=DASH_DURATION;
                    let m=Math.sqrt(player.dx*player.dx+player.dy*player.dy);
                    if(m>0)player.currentDashSpeed=player.speed*DASH_SPEED_MULTIPLIER;
                    else{player.dx=player.speed;player.currentDashSpeed=player.speed*DASH_SPEED_MULTIPLIER;}
                } else if(keys[' ']&&(player.isDashing||taggedDogInfo||player.isCurrentlyTagging||player.isMissLungeAnimating)){playFailSound();}
                if(player.trail.length>0)player.trail.pop();
            } else {
                player.dashTimer--;
                player.x+=player.dx*DASH_SPEED_MULTIPLIER;player.y+=player.dy*DASH_SPEED_MULTIPLIER;
                player.trail.unshift({x:player.x,y:player.y,width:player.width,height:player.height});
                if(player.trail.length>player.maxTrailLength)player.trail.pop();
                if(player.dashTimer<=0){
                    player.isDashing=false;player.currentDashSpeed=0;
                    if(!player.isCurrentlyTagging && !taggedDogInfo) { 
                        player.isMissLungeAnimating = true;
                        player.missLungeTimer = MISS_LUNGE_DURATION;
                        playFailSound(); 
                    }
                }
            }
            if(!player.isDashing&&!player.isMissLungeAnimating){player.x+=player.dx;player.y+=player.dy;}
            player.x=Math.max(0,Math.min(player.x,canvas.width-player.width));player.y=Math.max(0,Math.min(player.y,canvas.height-player.height));
        }
        function updateFemaleDog(dog){if(!player)return;const dX=player.x+player.width/2-(dog.x+dog.width/2);const dY=player.y+player.height/2-(dog.y+dog.height/2);const dist=Math.sqrt(dX*dX+dY*dY);if(dist<fleeRadius&&!player.isCurrentlyTagging){const angle=Math.atan2(dY,dX);dog.dx=-Math.cos(angle)*dog.speed;dog.dy=-Math.sin(angle)*dog.speed;}else{dog.moveTimer--;if(dog.moveTimer<=0){dog.dx=(Math.random()-0.5)*dog.speed*0.7;dog.dy=(Math.random()-0.5)*dog.speed*0.7;dog.moveTimer=Math.random()*120+60;}}dog.x+=dog.dx;dog.y+=dog.dy;if(dog.x<0){dog.x=0;dog.dx*=-1;}if(dog.x+dog.width>canvas.width){dog.x=canvas.width-dog.width;dog.dx*=-1;}if(dog.y<0){dog.y=0;dog.dy*=-1;}if(dog.y+dog.height>canvas.height){dog.y=canvas.height-dog.height;dog.dy*=-1;}}
        function updateTagAnimationAndScore(){if(taggedDogInfo){taggedDogInfo.animTimer--;if(taggedDogInfo.animTimer<-10)taggedDogInfo=null;}}
        
        function updateSuccessMessages(){for(let i=successMessages.length-1;i>=0;i--){const msg=successMessages[i];msg.timer--;msg.alpha=msg.timer/SUCCESS_TEXT_DURATION;msg.y-=0.5;msg.scale=1+(SUCCESS_TEXT_DURATION-msg.timer)/SUCCESS_TEXT_DURATION*0.3;if(msg.particles){for(let j=msg.particles.length-1;j>=0;j--){const p=msg.particles[j];p.x+=p.speedX;p.y+=p.speedY;p.alpha=p.duration/PARTICLE_DURATION;p.duration--;if(p.duration<=0)msg.particles.splice(j,1);}}if(msg.timer<=0)successMessages.splice(i,1);}}
        
        function updateHeartAnimations() {
            for (let i = heartAnimations.length - 1; i >= 0; i--) {
                const heart = heartAnimations[i];
                heart.timer--;
                heart.y -= heart.riseSpeed;
                heart.alpha = heart.timer / HEART_ANIM_DURATION;
                if (heart.phase === 'grow' && heart.currentScale < heart.maxScale) {
                    heart.currentScale += 0.05; 
                    if (heart.currentScale >= heart.maxScale) {
                        heart.phase = 'float';
                    }
                }
                if (heart.timer <= 0 || heart.alpha <= 0) {
                    heartAnimations.splice(i, 1);
                }
            }
        }

        function checkCollisions(){if(!player||player.isCurrentlyTagging||taggedDogInfo||player.isMissLungeAnimating)return;let newlyTaggedDogs=[];if(player.isDashing){for(let i=femaleDogs.length-1;i>=0;i--){const dog=femaleDogs[i];if(player.x<dog.x+dog.width&&player.x+player.width>dog.x&&player.y<dog.y+dog.height&&player.y+player.height>dog.y){newlyTaggedDogs.push({dog:dog,index:i,originalX:dog.x,originalY:dog.y,originalWidth:dog.width,originalHeight:dog.height});}}}if(newlyTaggedDogs.length>0){playTagSound();player.isDashing=false;player.dashTimer=0;player.trail=[];let successText="";let particlesForMessage=[];if(newlyTaggedDogs.length===1){const tagged=newlyTaggedDogs[0];score++;femaleDogSpawnTimer=FEMALE_DOG_SPAWN_COOLDOWN;player.isCurrentlyTagging=true;player.tagLockTimer=TAG_LOCK_DURATION;taggedDogInfo={dogData:{...tagged.dog},animTimer:TAG_ANIMATION_TOTAL_DURATION,originalX:tagged.originalX,originalY:tagged.originalY,scoreAwarded:true};femaleDogs.splice(tagged.index,1);successText=singleTagTexts[Math.floor(Math.random()*singleTagTexts.length)];heartAnimations.push({x:tagged.originalX+tagged.originalWidth/2,y:tagged.originalY-10,currentScale:0.1,maxScale:1.2,alpha:1,timer:HEART_ANIM_DURATION,riseSpeed:0.7,phase:'grow'});}else{score+=newlyTaggedDogs.length;femaleDogSpawnTimer=FEMALE_DOG_SPAWN_COOLDOWN;if(newlyTaggedDogs.length>=5)successText=multiTagTexts[5];else successText=multiTagTexts[newlyTaggedDogs.length]||`Combo x${newlyTaggedDogs.length}!`;for(let k=0;k<newlyTaggedDogs.length*5;k++){particlesForMessage.push(createParticle(player.x+player.width/2,player.y+player.height/2));}newlyTaggedDogs.forEach(tagged => {heartAnimations.push({x:tagged.originalX+tagged.originalWidth/2,y:tagged.originalY-10,currentScale:0.1,maxScale:1.0,alpha:1,timer:HEART_ANIM_DURATION,riseSpeed:0.6,phase:'grow'});});newlyTaggedDogs.sort((a,b)=>b.index-a.index);newlyTaggedDogs.forEach(tagged=>femaleDogs.splice(tagged.index,1));}if(successText){successMessages.push({text:successText,x:player.x+player.width/2,y:player.y-10,alpha:1,scale:1,timer:SUCCESS_TEXT_DURATION,particles:particlesForMessage});speakText(successText);}}}
        function spawnFemaleDogs(){if(femaleDogSpawnTimer>0){femaleDogSpawnTimer--;return;}if(femaleDogs.length<MAX_FEMALE_DOGS&&!taggedDogInfo&&!player.isCurrentlyTagging&&!player.isMissLungeAnimating){femaleDogs.push(createFemaleDog());}}

        function drawPlayer(){if(!player)return;if(player.trail.length>0){for(let i=0;i<player.trail.length;i++){const t=player.trail[i];const alpha=0.4*(1-(i+1)/(player.trail.length+1));ctx.globalAlpha=alpha;if(playerImg.complete&&playerImg.naturalWidth!==0)ctx.drawImage(playerImg,t.x,t.y,t.width,t.height);ctx.globalAlpha=1.0;}}
            if(player.isMissLungeAnimating){ 
                const lungeProgress = (MISS_LUNGE_DURATION - player.missLungeTimer) / MISS_LUNGE_DURATION;
                const lungeYOffset = Math.sin(lungeProgress * Math.PI) * - (player.height * 0.2); 
                if(playerImg.complete&&playerImg.naturalWidth!==0)ctx.drawImage(playerImg,player.x,player.y + lungeYOffset,player.width,player.height);
                else{ctx.fillStyle='saddlebrown';ctx.fillRect(player.x,player.y + lungeYOffset,player.width,player.height);}
            } else if(!player.isCurrentlyTagging){
                if(playerImg.complete&&playerImg.naturalWidth!==0)ctx.drawImage(playerImg,player.x,player.y,player.width,player.height);
                else{ctx.fillStyle='saddlebrown';ctx.fillRect(player.x,player.y,player.width,player.height);}
            }
        }
        function drawFemaleDog(dog){if(femaleDogImg.complete&&femaleDogImg.naturalWidth!==0)ctx.drawImage(femaleDogImg,dog.x,dog.y,dog.width,dog.height);else{ctx.fillStyle='lightpink';ctx.fillRect(dog.x,dog.y,dog.width,dog.height);}}
        function drawActiveTagAnimation(){if(!taggedDogInfo||taggedDogInfo.animTimer<=-10)return;const td=taggedDogInfo.dogData;const animTimer=taggedDogInfo.animTimer;if(player&&player.isCurrentlyTagging){const hopProgress=(TAG_LOCK_DURATION-player.tagLockTimer)/TAG_LOCK_DURATION;const dogBounceY=Math.sin(hopProgress*Math.PI)*(td.height*0.1);if(femaleDogImg.complete&&femaleDogImg.naturalWidth!==0)ctx.drawImage(femaleDogImg,td.x,td.y+dogBounceY,td.width,td.height);else{ctx.fillStyle='lightpink';ctx.fillRect(td.x,td.y+dogBounceY,td.width,td.height);}if(playerImg.complete&&playerImg.naturalWidth!==0)ctx.drawImage(playerImg,player.x,player.y,player.width,player.height);else{ctx.fillStyle='saddlebrown';ctx.fillRect(player.x,player.y,player.width,player.height);}}else{const fadeDuration=TAG_ANIMATION_TOTAL_DURATION-TAG_LOCK_DURATION;const currentFadeTime=animTimer;const fadeProgress=Math.max(0,Math.min(1,currentFadeTime/fadeDuration));ctx.globalAlpha=fadeProgress;const scale=fadeProgress*0.8+0.2;const drawX=td.x+(td.width*(1-scale))/2;const drawY=td.y+(td.height*(1-scale))/2;if(femaleDogImg.complete&&femaleDogImg.naturalWidth!==0)ctx.drawImage(femaleDogImg,drawX,drawY,td.width*scale,td.height*scale);else{ctx.fillStyle='lightpink';ctx.fillRect(drawX,drawY,td.width*scale,td.height*scale);}ctx.globalAlpha=1.0;}}
        function drawSuccessMessages(){successMessages.forEach(msg=>{if(msg.particles){msg.particles.forEach(p=>{ctx.globalAlpha=p.alpha;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();});ctx.globalAlpha=1;}ctx.save();ctx.globalAlpha=msg.alpha;ctx.fillStyle='#FFD700';ctx.strokeStyle='#000000';ctx.lineWidth=2;const fontSize=Math.max(12,Math.min(24,canvas.width/35))*msg.scale;ctx.font=`${fontSize}px "Press Start 2P"`;ctx.textAlign='center';ctx.strokeText(msg.text,msg.x,msg.y);ctx.fillText(msg.text,msg.x,msg.y);ctx.restore();});}
        
        function drawHeart(x, y, size, alpha) {
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.fillStyle = 'red';
            ctx.strokeStyle = 'darkred';
            ctx.lineWidth = 2;
            ctx.beginPath();
            const topCurveHeight = size * 0.3;
            ctx.moveTo(x, y + topCurveHeight);
            ctx.bezierCurveTo(x, y, x - size / 2, y, x - size / 2, y + topCurveHeight);
            ctx.bezierCurveTo(x - size / 2, y + (size + topCurveHeight) / 2, x, y + (size + topCurveHeight) / 2 + topCurveHeight /2 , x, y + size);
            ctx.bezierCurveTo(x, y + (size + topCurveHeight) / 2 + topCurveHeight /2, x + size / 2, y + (size + topCurveHeight) / 2, x + size / 2, y + topCurveHeight);
            ctx.bezierCurveTo(x + size / 2, y, x, y, x, y + topCurveHeight);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.restore();
        }

        function drawHeartAnimations() {
            heartAnimations.forEach(heart => {
                drawHeart(heart.x - (10 * heart.currentScale) / 2, heart.y - (10 * heart.currentScale) /2 , 10 * heart.currentScale, heart.alpha);
            });
        }
        
        function drawFlowers() {
            backgroundFlowers.forEach(flower => {
                // Draw stem
                ctx.strokeStyle = flower.stemColor;
                ctx.lineWidth = Math.max(1, canvas.width / 200); // Scaled stem width
                ctx.beginPath();
                ctx.moveTo(flower.x, flower.y + flower.stemHeight); // Bottom of stem
                ctx.lineTo(flower.x, flower.y); // Top of stem (base of flower head)
                ctx.stroke();

                // Draw petals
                ctx.fillStyle = flower.petalColor;
                for (let i = 0; i < flower.numPetals; i++) {
                    const angle = (i / flower.numPetals) * Math.PI * 2;
                    const petalX = flower.x + Math.cos(angle) * (flower.centerRadius + flower.petalRadius / 2);
                    const petalY = flower.y + Math.sin(angle) * (flower.centerRadius + flower.petalRadius / 2);
                    ctx.beginPath();
                    ctx.arc(petalX, petalY, flower.petalRadius, 0, Math.PI * 2);
                    ctx.fill();
                }
                // Draw center
                ctx.fillStyle = '#FFD700'; // Yellow center
                ctx.beginPath();
                ctx.arc(flower.x, flower.y, flower.centerRadius, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawScoreOnCanvas(){ctx.fillStyle='#FFFFFF';const baseFontSize=24;const scaledFontSize=Math.max(12,Math.min(baseFontSize,canvas.width/30));ctx.font=`${scaledFontSize}px "Press Start 2P"`;ctx.textAlign='left';ctx.fillText('Skóre: '+score,canvas.width*0.02,canvas.height*0.05);}
        
        function initGameLogic(){
            resizeCanvas();
            const scaleFactor=canvas.width/800;
            currentSpriteScale=SPRITE_SCALE_BASE*Math.max(0.7,Math.min(1.5,scaleFactor*1.1));
            playerSpeed=PLAYER_SPEED_BASE*Math.max(0.7,Math.min(1.5,scaleFactor));
            femaleDogSpeed=FEMALE_DOG_SPEED_BASE*Math.max(0.7,Math.min(1.5,scaleFactor));
            fleeRadius=FLEE_RADIUS_BASE*Math.max(0.7,Math.min(1.5,scaleFactor));
            player=createPlayer();
            femaleDogs=[];
            backgroundFlowers = []; // Initialize flowers
            const numFlowers = 20 + Math.floor(Math.random() * 10); // 20-29 flowers
            for (let i = 0; i < numFlowers; i++) {
                backgroundFlowers.push(createFlower());
            }
            for(let i=0;i<Math.floor(MAX_FEMALE_DOGS/2)+1;i++){femaleDogs.push(createFemaleDog());}
            score=0;keys={};femaleDogSpawnTimer=0;taggedDogInfo=null;successMessages=[]; heartAnimations = [];
        }

        let animationFrameId;
        function gameLoop(){
            if(gameState==='menu'){}
            else if(gameState==='leaderboard'){ctx.clearRect(0,0,canvas.width,canvas.height);}
            else if(gameState==='countdown'){drawCountdown();}
            else if(gameState==='playing'){
                updatePlayer();femaleDogs.forEach(updateFemaleDog);
                updateTagAnimationAndScore();updateSuccessMessages(); updateHeartAnimations();
                checkCollisions();spawnFemaleDogs();
                ctx.clearRect(0,0,canvas.width,canvas.height); 
                drawFlowers(); // Draw flowers first
                femaleDogs.forEach(drawFemaleDog);drawPlayer(); 
                drawActiveTagAnimation();drawSuccessMessages(); drawHeartAnimations();
                drawScoreOnCanvas();drawGameTimer();
                controlsContainer.style.display = 'flex'; 
            } else if(gameState==='gameOver'){
                ctx.clearRect(0,0,canvas.width,canvas.height);
                controlsContainer.style.display = 'none'; 
            }
            animationFrameId=requestAnimationFrame(gameLoop); 
        }
        
        showMenu();
        requestAnimationFrame(gameLoop); 
        
    </script>
</body>
</html>
